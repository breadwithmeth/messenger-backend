# Socket.IO Architecture - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Real-Time —Å–∏—Å—Ç–µ–º—ã

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

Backend —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–∞ –±–∞–∑–µ **Socket.IO** –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –±–µ–∑ polling –∑–∞–ø—Ä–æ—Å–æ–≤.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         HTTP Server                              ‚îÇ
‚îÇ                      (Express + Socket.IO)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ                                     ‚îÇ
             ‚îú‚îÄ REST API                           ‚îú‚îÄ WebSocket (Socket.IO)
             ‚îÇ  /api/chats                         ‚îÇ
             ‚îÇ  /api/messages                      ‚îÇ  JWT Authentication
             ‚îÇ  /api/tickets                       ‚îÇ  Rooms (org/user/chat)
             ‚îÇ                                     ‚îÇ
             ‚ñº                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Message Sources                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Baileys       ‚îÇ      WABA       ‚îÇ       Telegram              ‚îÇ
‚îÇ  (WhatsApp QR)  ‚îÇ  (WhatsApp API) ‚îÇ      (Bot API)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                 ‚îÇ                 ‚îÇ
         ‚îÇ                 ‚îÇ                 ‚îÇ
         ‚ñº                 ‚ñº                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   PostgreSQL Database                           ‚îÇ
‚îÇ  - Chats                                                        ‚îÇ
‚îÇ  - Messages                                                     ‚îÇ
‚îÇ  - Users                                                        ‚îÇ
‚îÇ  - Organizations                                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ Socket.IO Notifications
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Connected Clients                              ‚îÇ
‚îÇ  - Web Dashboard                                                ‚îÇ
‚îÇ  - Mobile Apps                                                  ‚îÇ
‚îÇ  - Third-party integrations                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. socketService.ts

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/services/socketService.ts`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO —Å–µ—Ä–≤–µ—Ä–∞
- JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏ (rooms)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```typescript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
initializeSocketIO(httpServer: http.Server)

// –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
getSocketIO(): Server | null

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
notifyNewChat(organizationId, chatData)
notifyNewMessage(organizationId, messageData)
notifyChatsUpdated(organizationId, chatData)
notifyMessagesRead(organizationId, chatId, readByUserId)
notifyMessageStatus(organizationId, messageId, status, chatId)
notifyChatDeleted(organizationId, chatId)
notifyUser(userId, event, data)
broadcastToOrganization(organizationId, event, data)
```

### 2. server.ts

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/server.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è Socket.IO:**
- –°–æ–∑–¥–∞–Ω–∏–µ HTTP —Å–µ—Ä–≤–µ—Ä–∞ –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Express
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `server.listen()` –≤–º–µ—Å—Ç–æ `app.listen()`

```typescript
import { initializeSocketIO } from './services/socketService';
import http from 'http';

const server = http.createServer(app);
initializeSocketIO(server);
server.listen(port, () => {
  console.log(`Socket.IO –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ ws://localhost:${port}`);
});
```

### 3. baileys.ts

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/config/baileys.ts`

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Socket.IO:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–≤—Ö–æ–¥—è—â–µ–≥–æ)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏—Å—Ö–æ–¥—è—â–µ–≥–æ)

```typescript
import { notifyNewChat, notifyNewMessage, notifyChatsUpdated } from '../services/socketService';

// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞
const newChat = await prisma.chat.create({ ... });
notifyNewChat(organizationId, newChat);

// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
const savedMessage = await prisma.message.create({ ... });
notifyNewMessage(organizationId, savedMessage);
```

### 4. wabaController.ts

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/controllers/wabaController.ts`

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Socket.IO:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ WABA

```typescript
const savedMessage = await prisma.message.create({ ... });

const { notifyNewMessage } = await import('../services/socketService');
notifyNewMessage(orgPhone.organizationId, {
  id: savedMessage.id,
  chatId: savedMessage.chatId,
  content: savedMessage.content,
  // ...
  channel: 'whatsapp',
});
```

### 5. telegramService.ts

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/services/telegramService.ts`

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Socket.IO:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ Telegram

```typescript
const savedMessage = await prisma.message.create({ ... });

const { notifyNewMessage } = await import('./socketService');
notifyNewMessage(organizationId, {
  id: savedMessage.id,
  chatId: savedMessage.chatId,
  content: savedMessage.content,
  // ...
  channel: 'telegram',
});
```

### 6. messageController.ts

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/controllers/messageController.ts`

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Socket.IO:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º —á–µ—Ä–µ–∑ WABA
- Baileys –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `sendMessage()` –≤ baileys.ts

```typescript
// WABA –≤–µ—Ç–∫–∞
const savedMessage = await prisma.message.create({ ... });

const { notifyNewMessage } = await import('../services/socketService');
notifyNewMessage(organizationId, {
  id: savedMessage.id,
  chatId: savedMessage.chatId,
  // ...
  fromMe: true,
  senderUserId: userId,
  channel: 'whatsapp',
});
```

---

## –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–Ω–∞—Ç (Rooms)

Socket.IO –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **rooms** –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.

### –¢–∏–ø—ã –∫–æ–º–Ω–∞—Ç:

#### 1. Organization Room
**–§–æ—Ä–º–∞—Ç:** `org_${organizationId}`

**–¶–µ–ª—å:** –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:**
- `chat:new` - –Ω–æ–≤—ã–π —á–∞—Ç
- `message:new` - –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–æ)
- `chat:updated` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
- `messages:read` - –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `message:status` - —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è
- `chat:deleted` - —É–¥–∞–ª—ë–Ω–Ω—ã–π —á–∞—Ç

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```typescript
socket.join(`org_${organizationId}`);
```

#### 2. User Room
**–§–æ—Ä–º–∞—Ç:** `user_${userId}`

**–¶–µ–ª—å:** –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:**
- `user:notification` - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —á–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
- –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```typescript
socket.join(`user_${userId}`);
```

#### 3. Chat Room
**–§–æ—Ä–º–∞—Ç:** `chat_${chatId}`

**–¶–µ–ª—å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –æ—Ç–∫—Ä—ã–≤—à–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Ç

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:**
- `typing:start` - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
- `typing:stop` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—á–∞—Ç–∏
- –ü—Ä—è–º—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —á–∞—Ç—É

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:** –ü–æ –∑–∞–ø—Ä–æ—Å—É –∫–ª–∏–µ–Ω—Ç–∞

```typescript
socket.emit('subscribe:chat', { chatId: 123 });
// –°–µ—Ä–≤–µ—Ä: socket.join(`chat_${chatId}`);
```

---

## Flow –¥–∏–∞–≥—Ä–∞–º–º—ã

### –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—Ç –∫–ª–∏–µ–Ω—Ç–∞)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client    ‚îÇ
‚îÇ  (WhatsApp/ ‚îÇ
‚îÇ  Telegram)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Message Source  ‚îÇ
‚îÇ (Baileys/WABA/   ‚îÇ
‚îÇ   Telegram Bot)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ Webhook/Event
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Controller/    ‚îÇ
‚îÇ   Service        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 1. Ensure chat
       ‚îÇ 2. Save message
       ‚îÇ 3. Update unread count
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Database       ‚îÇ
‚îÇ  (PostgreSQL)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ Message saved
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  socketService   ‚îÇ
‚îÇ notifyNewMessage ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ Broadcast to org_${id}
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  All Operators   ‚îÇ
‚îÇ   in Org         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ò—Å—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Operator   ‚îÇ
‚îÇ  Dashboard  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ POST /api/messages/send
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Message         ‚îÇ
‚îÇ  Controller      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 1. Validate
       ‚îÇ 2. Send via channel
       ‚îÇ 3. Save to DB
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Database       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ Message saved
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  socketService   ‚îÇ
‚îÇ notifyNewMessage ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ Broadcast to org_${id}
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  All Operators in Org    ‚îÇ
‚îÇ  (including sender)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ Update UI
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Client          ‚îÇ
‚îÇ  (WhatsApp/      ‚îÇ
‚îÇ   Telegram)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### JWT Authentication

–ö–∞–∂–¥–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é:

```typescript
io.use(async (socket, next) => {
  const token = socket.handshake.auth.token;
  
  if (!token) {
    return next(new Error('Authentication failed: No token provided'));
  }
  
  try {
    const decoded = jwt.verify(token, JWT_SECRET);
    socket.data.userId = decoded.userId;
    socket.data.organizationId = decoded.organizationId;
    next();
  } catch (error) {
    next(new Error('Authentication failed: Invalid token'));
  }
});
```

### Room Isolation

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ —Å–≤–æ–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–∏–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ `org_${id}`)
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `user_${id}`
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —á–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á–∞—Ç–æ–≤ —Å–≤–æ–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

### Event Validation

- –í—Å–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–æ–ª–µ–π
- chatId –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (Single Server)

Socket.IO —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–∞–º—è—Ç–∏ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –æ–¥–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É

### –ë—É–¥—É—â–µ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis Adapter)

–î–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Redis Adapter:

```typescript
import { createAdapter } from '@socket.io/redis-adapter';
import { createClient } from 'redis';

const pubClient = createClient({ url: 'redis://localhost:6379' });
const subClient = pubClient.duplicate();

await Promise.all([pubClient.connect(), subClient.connect()]);

io.adapter(createAdapter(pubClient, subClient));
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°–æ–±—ã—Ç–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏
- Load balancing

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ Socket.IO –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ Pino:

```typescript
logger.info(`[Socket.IO] –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω: ${socket.id}`);
logger.info(`[Socket.IO] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ org_${organizationId}`);
logger.error('[Socket.IO] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
```

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤: `io.engine.clientsCount`
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç: `io.sockets.adapter.rooms.size`
- –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: –ª–æ–≥–∏ `[Socket.IO] –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏`

---

## –û—Ç–ª–∞–¥–∫–∞

### –í–∫–ª—é—á–µ–Ω–∏–µ debug —Ä–µ–∂–∏–º–∞

```typescript
// –í server.ts –∏–ª–∏ socketService.ts
const io = new Server(httpServer, {
  cors: { origin: '*' },
  transports: ['websocket', 'polling'],
});

// –í–∫–ª—é—á–∏—Ç—å debug –ª–æ–≥–∏
io.engine.on('connection_error', (err) => {
  console.log('[Debug] Connection error:', err);
});
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ socket.io-client –≥–ª–æ–±–∞–ª—å–Ω–æ
npm install -g socket.io-client

# –°–æ–∑–¥–∞–π—Ç–µ test-socket.js
const io = require('socket.io-client');

const socket = io('http://localhost:3000', {
  auth: { token: 'YOUR_JWT_TOKEN' }
});

socket.on('connect', () => {
  console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
  socket.emit('subscribe:chat', { chatId: 1 });
});

socket.on('message:new', (data) => {
  console.log('üì© –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
});

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ
node test-socket.js
```

---

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **[SOCKET_IO_DOCUMENTATION.md](./SOCKET_IO_DOCUMENTATION.md)** - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
- **[SOCKET_IO_QUICK_START.md](./SOCKET_IO_QUICK_START.md)** - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- **[API_DOCUMENTATION.md](./API_DOCUMENTATION.md)** - REST API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## Changelog

### v1.0.0 (2025-12-14)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –ë–∞–∑–æ–≤–∞—è Socket.IO –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–Ω–∞—Ç (org, user, chat)
- ‚úÖ –°–æ–±—ã—Ç–∏—è: chat:new, message:new, chat:updated, messages:read, message:status, chat:deleted, user:notification
- ‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è: subscribe:chat, unsubscribe:chat, typing:start, typing:stop
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Baileys (WhatsApp QR)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WABA (WhatsApp Business API)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Bot API
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
- Baileys: –≤—Ö–æ–¥—è—â–∏–µ –∏ –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ–≤—ã–µ —á–∞—Ç—ã
- WABA: –≤—Ö–æ–¥—è—â–∏–µ –∏ –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- Telegram: –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ JWT —Ç–æ–∫–µ–Ω (–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è)
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω –∏ Socket.IO –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend: `[Socket.IO]` –ø—Ä–µ—Ñ–∏–∫—Å
5. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ browser devtools ‚Üí Network ‚Üí WS –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
