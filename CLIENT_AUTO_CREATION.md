# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ WhatsApp –∏–ª–∏ Telegram. –ö–ª–∏–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è —Å —á–∞—Ç–∞–º–∏ –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.

---

## –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

### WhatsApp

–ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ WhatsApp:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è**: –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç –Ω–∞—Å (`!msg.key.fromMe`)
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è**: –ò—â–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç –ø–æ `whatsappJid` –≤ —Ä–∞–º–∫–∞—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
3. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞**: –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π:
   - `clientType`: `individual`
   - `name`: –ò–º—è –∏–∑ `pushName` –∏–ª–∏ `WhatsApp {phone}`
   - `phone`: –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ JID (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º +)
   - `whatsappJid`: JID –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `79001234567@s.whatsapp.net`)
   - `status`: `active`
   - `source`: `whatsapp`
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ**: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏–º—è (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
5. **–°–≤—è–∑—ã–≤–∞–Ω–∏–µ —Å —á–∞—Ç–æ–º**: –ö–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å —á–∞—Ç–æ–º —á–µ—Ä–µ–∑ many-to-many –æ—Ç–Ω–æ—à–µ–Ω–∏–µ
6. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

**–õ–æ–≥–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏:**
```
üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è 79001234567@s.whatsapp.net...
‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç WhatsApp: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (ID: 15, JID: 79001234567@s.whatsapp.net)
üîó –ö–ª–∏–µ–Ω—Ç #15 —Å–≤—è–∑–∞–Ω —Å —á–∞—Ç–æ–º #42
```

### Telegram

–ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Telegram:

1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**: –ü–æ–ª—É—á–∞—é—Ç—Å—è userId, username, firstName, lastName –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è**: –ò—â–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç –ø–æ `telegramUserId` –≤ —Ä–∞–º–∫–∞—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
3. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞**: –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π:
   - `clientType`: `individual`
   - `name`: `{firstName} {lastName}` –∏–ª–∏ `@username` –∏–ª–∏ `Telegram User {userId}`
   - `telegramUserId`: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
   - `status`: `active`
   - `source`: `telegram`
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ**: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
5. **–°–≤—è–∑—ã–≤–∞–Ω–∏–µ —Å —á–∞—Ç–æ–º**: –ö–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å —á–∞—Ç–æ–º
6. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

**–õ–æ–≥–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏:**
```
üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ Telegram –¥–ª—è UserID: 123456789...
‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç Telegram: –ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞ (ID: 16, UserID: 123456789, @maria_ivanova)
üîó –ö–ª–∏–µ–Ω—Ç #16 —Å–≤—è–∑–∞–Ω —Å Telegram —á–∞—Ç–æ–º #43
```

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –°–µ—Ä–≤–∏—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

–§–∞–π–ª: `src/services/clientService.ts`

#### `ensureWhatsAppClient()`

```typescript
await ensureWhatsAppClient(
  organizationId: number,
  whatsappJid: string,
  name?: string
)
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `organizationId` - ID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- `whatsappJid` - JID –∫–ª–∏–µ–Ω—Ç–∞ –≤ WhatsApp
- `name` - –ò–º—è –∏–∑ pushName (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `OrganizationClient`

**–ü—Ä–∏–º–µ—Ä:**
```typescript
const client = await ensureWhatsAppClient(
  1,
  '79001234567@s.whatsapp.net',
  '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤'
);
```

#### `ensureTelegramClient()`

```typescript
await ensureTelegramClient(
  organizationId: number,
  telegramUserId: string,
  telegramUsername?: string,
  firstName?: string,
  lastName?: string
)
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `organizationId` - ID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- `telegramUserId` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
- `telegramUsername` - Username (@username)
- `firstName` - –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `lastName` - –§–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `OrganizationClient`

**–ü—Ä–∏–º–µ—Ä:**
```typescript
const client = await ensureTelegramClient(
  1,
  '123456789',
  'ivanov',
  '–ò–≤–∞–Ω',
  '–ò–≤–∞–Ω–æ–≤'
);
```

#### `linkClientToChat()`

```typescript
await linkClientToChat(
  clientId: number,
  chatId: number
)
```

–°–≤—è–∑—ã–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ —Å —á–∞—Ç–æ–º (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞).

#### `updateClientPurchaseStats()`

```typescript
await updateClientPurchaseStats(
  clientId: number,
  purchaseAmount: number
)
```

–û–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏.

**–û–±–Ω–æ–≤–ª—è–µ–º—ã–µ –ø–æ–ª—è:**
- `totalRevenue` - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Å—É–º–º—É –ø–æ–∫—É–ø–∫–∏
- `purchaseCount` - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 1
- `averageCheck` - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- `lastPurchaseDate` - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### WhatsApp (baileys.ts)

```typescript
// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞
if (!msg.key.fromMe) {
  try {
    const { ensureWhatsAppClient, linkClientToChat } = await import('../services/clientService');
    const client = await ensureWhatsAppClient(organizationId, senderJid, contactName);
    await linkClientToChat(client.id, chatId);
  } catch (clientError) {
    logger.error(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è ${senderJid}:`, clientError);
  }
}
```

### Telegram (telegramService.ts)

```typescript
// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞
try {
  const { ensureTelegramClient, linkClientToChat } = await import('./clientService');
  if (userId) {
    const client = await ensureTelegramClient(
      organizationId,
      userId,
      username,
      firstName,
      lastName
    );
    await linkClientToChat(client.id, chat.id);
  }
} catch (clientError) {
  logger.error(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ Telegram:`, clientError);
}
```

---

## API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É –∫–ª–∏–µ–Ω—Ç—É

**PUT** `/api/clients/:id/financials`

–û–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ —Å–æ–≤–µ—Ä—à–µ–Ω–∏–∏ –ø–æ–∫—É–ø–∫–∏.

#### –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞

```json
{
  "purchaseAmount": 5000.00
}
```

#### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞

```bash
curl -X PUT "http://localhost:3000/api/clients/15/financials" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "purchaseAmount": 5000.00
  }'
```

#### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞

```json
{
  "id": 15,
  "organizationId": 1,
  "name": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
  "email": "ivan@example.com",
  "totalRevenue": "25000.00",
  "purchaseCount": 5,
  "averageCheck": "5000.00",
  "lastPurchaseDate": "2025-12-01T12:00:00.000Z",
  "updatedAt": "2025-12-01T12:00:00.000Z"
}
```

---

## –õ–æ–≥–∏

–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
```
üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è 79001234567@s.whatsapp.net...
```

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ WhatsApp
```
‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç WhatsApp: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (ID: 15, JID: 79001234567@s.whatsapp.net)
üîó –ö–ª–∏–µ–Ω—Ç #15 —Å–≤—è–∑–∞–Ω —Å —á–∞—Ç–æ–º #42
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
```
üîç –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–∏–µ–Ω—Ç WhatsApp: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (ID: 15)
üìù –û–±–Ω–æ–≤–ª–µ–Ω–æ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ WhatsApp: –ò–≤–∞–Ω –ü. –ü–µ—Ç—Ä–æ–≤ (79001234567@s.whatsapp.net)
üîó –ö–ª–∏–µ–Ω—Ç #15 —Å–≤—è–∑–∞–Ω —Å —á–∞—Ç–æ–º #42
```

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ Telegram
```
üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ Telegram –¥–ª—è UserID: 123456789...
‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç Telegram: –ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞ (ID: 16, UserID: 123456789, @maria_ivanova)
üîó –ö–ª–∏–µ–Ω—Ç #16 —Å–≤—è–∑–∞–Ω —Å Telegram —á–∞—Ç–æ–º #43
```

### –ü—Ä–æ–ø—É—Å–∫ –∏—Å—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
```
‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∏—Å—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
```

### –û—à–∏–±–∫–∏
```
‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è 79001234567@s.whatsapp.net: [–¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏]
‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ WhatsApp (79001234567@s.whatsapp.net): [–¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏]
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ WhatsApp

```javascript
const whatsappClients = await fetch('http://localhost:3000/api/clients?source=whatsapp', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

### –ü–æ–ª—É—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞

```bash
# WhatsApp –∫–ª–∏–µ–Ω—Ç—ã
GET /api/clients?source=whatsapp

# Telegram –∫–ª–∏–µ–Ω—Ç—ã
GET /api/clients?source=telegram
```

### –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∫—É–ø–æ–∫

```javascript
// –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—Ç–∞–ª –ª–∏ –∫–ª–∏–µ–Ω—Ç VIP
const updateClientSegment = async (clientId) => {
  const client = await fetch(`http://localhost:3000/api/clients/${clientId}`, {
    headers: { 'Authorization': `Bearer ${token}` }
  }).then(r => r.json());

  // –ï—Å–ª–∏ –≤—ã—Ä—É—á–∫–∞ –±–æ–ª—å—à–µ 100,000, –¥–µ–ª–∞–µ–º VIP
  if (parseFloat(client.totalRevenue) > 100000) {
    await fetch(`http://localhost:3000/api/clients/${clientId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        segment: 'VIP',
        discount: 15.00
      })
    });
  }
};
```

### –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ WhatsApp JID

```javascript
const findClientByWhatsApp = async (whatsappJid) => {
  const clients = await fetch(
    `http://localhost:3000/api/clients?search=${whatsappJid}`,
    {
      headers: { 'Authorization': `Bearer ${token}` }
    }
  ).then(r => r.json());
  
  return clients.clients.find(c => c.whatsappJid === whatsappJid);
};
```

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è

1. **–ù–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞**: –ö–ª–∏–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ
2. **–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: –ò–º–µ–Ω–∞ –∏ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. **–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è**: –í—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
4. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤
5. **–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞–Ω–∞–ª–∞–º —Å–≤—è–∑–∏
6. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –ö–ª–∏–µ–Ω—Ç—ã —Å–≤—è–∑–∞–Ω—ã —Å —á–∞—Ç–∞–º–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

---

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É/email)
- –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- AI-–∞–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—â–µ–Ω–∏—è
- –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –æ—Ç—Ç–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:

```typescript
// –í .env
AUTO_CREATE_CLIENTS=true

// –í –∫–æ–¥–µ
if (process.env.AUTO_CREATE_CLIENTS === 'true') {
  await ensureWhatsAppClient(...);
}
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ö–ª–∏–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–π –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∞—É–¥–∏—Ç–∞
- –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ JID/userId

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤:

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞

–ù–∞–π–¥–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö —Å—Ç—Ä–æ–∫–∏ —Å —ç–º–æ–¥–∑–∏:
```bash
# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏:
grep "üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞" logs/app.log
grep "‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç" logs/app.log
grep "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞" logs/app.log
```

### 2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ —Å—Ö–µ–º—ã

```bash
npx prisma migrate dev
npx prisma generate
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
./scripts/test-client-auto-creation.sh
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î –Ω–∞–ø—Ä—è–º—É—é

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
SELECT * FROM "OrganizationClient" WHERE "organizationId" = 1 ORDER BY "createdAt" DESC LIMIT 10;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å —á–∞—Ç–∞–º–∏
SELECT 
  c.id as chat_id, 
  c.name as chat_name,
  oc.id as client_id,
  oc.name as client_name,
  oc.source
FROM "_ChatOrganizationClients" coc
JOIN "Chat" c ON c.id = coc."A"
JOIN "OrganizationClient" oc ON oc.id = coc."B"
ORDER BY c."lastMessageAt" DESC
LIMIT 20;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã
SELECT 
  id, 
  name, 
  source, 
  "whatsappJid", 
  "telegramUserId", 
  status,
  "createdAt"
FROM "OrganizationClient"
WHERE "organizationId" = 1
ORDER BY "createdAt" DESC
LIMIT 10;
```

### 5. –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ö–ª–∏–µ–Ω—Ç –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è:**
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–µ (–Ω–µ –æ—Ç –≤–∞—Å)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

**–ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ —Å–≤—è–∑–∞–Ω —Å —á–∞—Ç–æ–º:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É `_ChatOrganizationClients`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–∏ `linkClientToChat`

**–î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–ª–∏–µ–Ω—Ç—ã:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ `whatsappJid` –∏–ª–∏ `telegramUserId`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### 6. –û—Ç–ª–∞–¥–∫–∞

–î–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ –≤–∫–ª—é—á–∏—Ç–µ debug –ª–æ–≥–∏:

```typescript
// –í .env
LOG_LEVEL=debug
```

–¢–µ–ø–µ—Ä—å –≤—ã —É–≤–∏–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ª–æ–≥–∏:
```
‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∏—Å—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
üîç –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–∏–µ–Ω—Ç WhatsApp: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (ID: 15)
```
