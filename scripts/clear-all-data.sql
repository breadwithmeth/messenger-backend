-- ============================================================================
-- Скрипт для быстрого удаления всех чатов и сообщений через SQL
-- ============================================================================
-- 
-- ВНИМАНИЕ: Это действие НЕОБРАТИМО!
-- Создайте резервную копию перед выполнением:
--   pg_dump -U postgres messenger_db > backup-$(date +%Y%m%d-%H%M%S).sql
--
-- Использование:
--   psql -U postgres -d messenger_db -f scripts/clear-all-data.sql
--
-- Или интерактивно:
--   psql -U postgres -d messenger_db
--   \i scripts/clear-all-data.sql
-- ============================================================================

\set ON_ERROR_STOP on

-- Показываем текущую статистику
\echo ''
\echo '═══════════════════════════════════════════════════════════'
\echo '  📊 СТАТИСТИКА ПЕРЕД УДАЛЕНИЕМ'
\echo '═══════════════════════════════════════════════════════════'
\echo ''

SELECT 
    '📨 Сообщений:' as "Тип",
    COUNT(*)::text as "Количество"
FROM "Message"
UNION ALL
SELECT 
    '💬 Чатов:' as "Тип",
    COUNT(*)::text as "Количество"
FROM "Chat"
UNION ALL
SELECT 
    '🏢 Организаций:' as "Тип",
    COUNT(*)::text as "Количество"
FROM "Organization";

\echo ''
\echo '⚠️  ВНИМАНИЕ: Все данные будут удалены через 5 секунд...'
\echo '   Нажмите Ctrl+C для отмены'
\echo ''

-- Пауза 5 секунд (работает только в psql)
SELECT pg_sleep(5);

\echo ''
\echo '═══════════════════════════════════════════════════════════'
\echo '  🗑️  УДАЛЕНИЕ ДАННЫХ'
\echo '═══════════════════════════════════════════════════════════'
\echo ''

-- Начинаем транзакцию
BEGIN;

\echo '📨 Удаление сообщений...'
DELETE FROM "Message";
\echo '   ✅ Выполнено'

\echo '💬 Удаление чатов...'
DELETE FROM "Chat";
\echo '   ✅ Выполнено'

-- Фиксируем транзакцию
COMMIT;

\echo ''
\echo '═══════════════════════════════════════════════════════════'
\echo '  📊 СТАТИСТИКА ПОСЛЕ УДАЛЕНИЯ'
\echo '═══════════════════════════════════════════════════════════'
\echo ''

SELECT 
    '📨 Сообщений:' as "Тип",
    COUNT(*)::text as "Количество"
FROM "Message"
UNION ALL
SELECT 
    '💬 Чатов:' as "Тип",
    COUNT(*)::text as "Количество"
FROM "Chat";

\echo ''
\echo '✅ Удаление завершено успешно!'
\echo ''
