# Messenger Backend - –ú—É–ª—å—Ç–∏–∫–∞–Ω–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å Real-Time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏

## üöÄ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### ü§ñ AI –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –û—Ç–≤–µ—Ç–æ–≤ (NEW!)
- **DeepSeek AI** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–º–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑** —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
- **1-10 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤** –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- **–†—É—Å—Å–∫–∏–π —è–∑—ã–∫** –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–Ω
- **–ë—ã—Å—Ç—Ä–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** –≤ UI

üìñ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [AI_SUGGESTIONS_API.md](./AI_SUGGESTIONS_API.md)

### ‚ö° Socket.IO Real-Time –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ –Ω–æ–≤—ã—Ö —á–∞—Ç–∞—Ö –∏ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
- **JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- **–°–∏—Å—Ç–µ–º–∞ –∫–æ–º–Ω–∞—Ç** (organization, user, chat)
- **7+ —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π** (chat:new, message:new, chat:updated, –∏ –¥—Ä.)
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ –≤—Å–µ–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏** (WhatsApp Baileys, WABA, Telegram)
- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

üìñ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [SOCKET_IO_README.md](./SOCKET_IO_README.md)

### üéØ –°–∏—Å—Ç–µ–º–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —á–∞—Ç–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º —á–∞—Ç–æ–≤ (–æ—Ç–∫—Ä—ã—Ç, –∑–∞–∫—Ä—ã—Ç, –≤ –æ–∂–∏–¥–∞–Ω–∏–∏)
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ —á–∞—Ç–æ–≤ (–Ω–∏–∑–∫–∏–π, –æ–±—ã—á–Ω—ã–π, –≤—ã—Å–æ–∫–∏–π, —Å—Ä–æ—á–Ω—ã–π)
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö/–Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤

### üì¨ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –û—Ç–º–µ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
- –ü–æ–¥—Å—á–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —á–∞—Ç–∞–º
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### üìé –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤
- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –≤–∏–¥–µ–æ, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∞—É–¥–∏–æ
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –∏ —Ä–∞–∑–º–µ—Ä–æ–≤ —Ñ–∞–π–ª–æ–≤
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ –≤ Cloudflare R2
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ URL –∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

### ‚òÅÔ∏è Cloudflare R2 Storage
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞ –≤ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- –ü—É–±–ª–∏—á–Ω—ã–µ URL –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∏–¥–µ–æ, –∞—É–¥–∏–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã)

## –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —á–∞—Ç–æ–≤
```
POST   /api/chat-assignment/:chatId/assign     - –ù–∞–∑–Ω–∞—á–∏—Ç—å —á–∞—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
DELETE /api/chat-assignment/:chatId/unassign   - –°–Ω—è—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
GET    /api/chat-assignment/assigned           - –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —á–∞—Ç—ã
GET    /api/chat-assignment/unassigned         - –ü–æ–ª—É—á–∏—Ç—å –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —á–∞—Ç—ã
POST   /api/chat-assignment/:chatId/close      - –ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç
```

### –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
```
POST /api/unread/:chatId/mark-read            - –û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
POST /api/unread/:chatId/mark-chat-read       - –û—Ç–º–µ—Ç–∏—Ç—å –≤–µ—Å—å —á–∞—Ç –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π
GET  /api/unread/counts                       - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
GET  /api/unread/chats                        - –ß–∞—Ç—ã —Å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
```

### –ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã
```
POST /api/media/send                          - –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–¥–∏–∞—Ñ–∞–π–ª
POST /api/media/upload                        - –ü—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞—Ñ–∞–π–ª
```

### AI –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤
```
GET /api/ai/suggestions/:chatId?limit=3       - –ü–æ–ª—É—á–∏—Ç—å AI-–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–∞
GET /api/ai/health                            - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ AI
```

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
```
GET /api/chats?status=open&assigned=true      - –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
GET /api/chats/:chatId/messages               - –°–æ–æ–±—â–µ–Ω–∏—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ
```

## –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ –º–æ–¥–µ–ª–∏ Chat
```prisma
assignedUserId    Int?           // ID –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
assignedUser      User?          // –°–≤—è–∑—å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
assignedAt        DateTime?      // –í—Ä–µ–º—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
status            String         // open, closed, pending
priority          String         // low, normal, high, urgent  
unreadCount       Int            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
```

### –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ –º–æ–¥–µ–ª–∏ Message
```prisma
isReadByOperator  Boolean        // –ü—Ä–æ—á–∏—Ç–∞–Ω–æ –ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
readAt            DateTime?      // –í—Ä–µ–º—è –ø—Ä–æ—á—Ç–µ–Ω–∏—è
senderUserId      Int?           // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
senderUser        User?          // –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —á–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
```javascript
const response = await fetch('/api/chat-assignment/1/assign', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + token,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    operatorId: 2
  })
});
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
```javascript
const formData = new FormData();
formData.append('media', imageFile);
formData.append('organizationPhoneId', '1');
formData.append('receiverJid', '79001234567@s.whatsapp.net');
formData.append('mediaType', 'image');
formData.append('caption', '–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');

const response = await fetch('/api/media/send', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + token
  },
  body: formData
});
```

### –û—Ç–º–µ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
```javascript
const response = await fetch('/api/unread/1/mark-read', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + token,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    messageIds: [1, 2, 3] // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  })
});
```

## –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
npm install
```

2. –°–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:
```bash
npm run build
```

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```bash
npm start
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –º–µ–¥–∏–∞

–ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:
```
public/
  media/
    image/      - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    video/      - –í–∏–¥–µ–æ—Ñ–∞–π–ª—ã  
    document/   - –î–æ–∫—É–º–µ–Ω—Ç—ã
    audio/      - –ê—É–¥–∏–æ—Ñ–∞–π–ª—ã
```

–î–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º: `http://server/media/image/filename.jpg`

–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `API_DOCUMENTATION.md`.
