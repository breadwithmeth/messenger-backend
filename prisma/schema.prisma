// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BaileysAuthState {
  id             Int      @id @default(autoincrement())
  organizationId Int
  phoneJid       String
  key            String // ключ, например "creds" или "pre-key:xyz"
  value          Bytes?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, phoneJid, key])
}

model BaileysAuth {
  organizationId Int
  phoneJid       String
  key            String
  value          String // Bytes в Prisma соответствует Buffer в Node.js
  type           String // <--- НОВОЕ ПОЛЕ: для хранения типа данных (e.g., 'json', 'buffer')

  @@id([organizationId, phoneJid, key]) // Составной первичный ключ
  @@map("baileys_auth") // Имя таблицы в базе данных
}

model Session {
  id             Int    @id @default(autoincrement())
  organizationId Int
  phoneJid       String

  status    String // connected, disconnected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, phoneJid])
}

model Organization {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())

  users          User[]
  Chat           Chat[]
  phones         OrganizationPhone[] // WhatsApp номера
  telegramBots   TelegramBot[]       // Telegram боты
  Message        Message[]
  clients        OrganizationClient[] // Клиенты организации
  clientTags     ClientTag[]          // Теги для клиентов
}

model User {
  id             Int          @id @default(autoincrement())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId Int
  email          String       @unique
  passwordHash   String
  name           String?
  role           String       @default("operator") // or 'admin'
  createdAt      DateTime     @default(now())

  // --- НОВОЕ ПОЛЕ ---
  // Связь с сообщениями, отправленными этим пользователем
  sentMessages   Message[]

  // Связь с назначенными чатами (как оператор)
  assignedChats  Chat[]       @relation("AssignedChats")

  // Связь с историей изменений тикетов
  ticketHistory  TicketHistory[]

  chats          Chat[]       @relation("ChatUsers")
  
  // Связь с клиентами (как менеджер)
  managedClients OrganizationClient[] @relation("ClientManager")
}

model Client {
  id        Int      @id @default(autoincrement())
  phoneJid  String   @unique // e.g. 79001112233@s.whatsapp.net
  name      String?
  createdAt DateTime @default(now())

  metadata ClientMetadata[]

  Chat Chat[] @relation("ChatClients")
}

model Message {
  id                  Int               @id @default(autoincrement())
  organizationId      Int
  organization        Organization      @relation(fields: [organizationId], references: [id])
  
  // Канал сообщения: whatsapp или telegram
  channel             String            @default("whatsapp") // whatsapp | telegram
  
  // WhatsApp-специфичные поля
  organizationPhoneId Int?
  organizationPhone   OrganizationPhone? @relation(fields: [organizationPhoneId], references: [id])
  whatsappMessageId   String?
  
  // Telegram-специфичные поля
  telegramBotId       Int?
  telegramBot         TelegramBot?      @relation(fields: [telegramBotId], references: [id])
  telegramMessageId   Int?              // ID сообщения в Telegram
  telegramChatId      String?           // Chat ID в Telegram (может быть число или строка)
  
  // Общие поля для обоих каналов
  chatId              Int
  chat                Chat              @relation(fields: [chatId], references: [id])
  receivingPhoneJid   String?           // Для WhatsApp
  remoteJid           String?           // Для WhatsApp
  senderJid           String?           // Для WhatsApp
  telegramUserId      String?           // Для Telegram (ID пользователя Telegram)
  telegramUsername    String?           // Для Telegram (@username)
  
  fromMe              Boolean
  content             String
  type                String            @default("text")
  mediaUrl            String?
  filename            String?
  mimeType            String?
  size                Int?
  timestamp           DateTime
  status              String            @default("pending") // e.g., pending, sent, delivered, read

  // Поле для отметки как прочитанное оператором
  isReadByOperator    Boolean           @default(false)
  readAt              DateTime?         // Когда сообщение было прочитано оператором

  // ID пользователя-оператора, который отправил это сообщение (если применимо)
  senderUserId        Int?
  senderUser          User?             @relation(fields: [senderUserId], references: [id], onDelete: SetNull)

  // Поля для ответов
  quotedMessageId     String?           // ID цитируемого сообщения
  quotedContent       String?           // Текст цитируемого сообщения

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt @default(now())
  
  @@index([channel])
  @@index([chatId, timestamp])
}
model ClientMetadata {
  id        Int      @id @default(autoincrement())
  client    Client   @relation(fields: [clientId], references: [id])
  clientId  Int
  key       String
  value     String
  createdAt DateTime @default(now())
}

// model MessageEvent {
//   id        Int      @id @default(autoincrement())
//   message   Message  @relation(fields: [messageId], references: [id])
//   messageId Int
//   status    String // sent / delivered / read
//   eventAt   DateTime @default(now())
// }

model Chat {
  id                  Int          @id @default(autoincrement())
  organization        Organization @relation(fields: [organizationId], references: [id])
  organizationId      Int
  name                String?
  createdAt           DateTime     @default(now())
  
  // Канал чата: whatsapp или telegram
  channel             String       @default("whatsapp") // whatsapp | telegram
  
  // WhatsApp-специфичные поля
  receivingPhoneJid   String?
  remoteJid           String?
  organizationPhoneId Int?
  organizationPhone   OrganizationPhone? @relation(fields: [organizationPhoneId], references: [id])
  isGroup             Boolean      @default(false)
  
  // Telegram-специфичные поля
  telegramBotId       Int?
  telegramBot         TelegramBot? @relation(fields: [telegramBotId], references: [id])
  telegramChatId      String?      // Chat ID в Telegram
  telegramUserId      String?      // User ID в Telegram
  telegramUsername    String?      // @username в Telegram
  telegramFirstName   String?      // Имя пользователя в Telegram
  telegramLastName    String?      // Фамилия пользователя в Telegram
  
  lastMessageAt       DateTime?

  // === ТИКЕТ-СИСТЕМА ===
  
  // Номер тикета (уникальный в рамках организации)
  ticketNumber        Int?         // Например: #12345
  
  // Поля для назначения чатов операторам
  assignedUserId      Int?         // ID оператора, которому назначен чат
  assignedUser        User?        @relation("AssignedChats", fields: [assignedUserId], references: [id], onDelete: SetNull)
  assignedAt          DateTime?    // Когда чат был назначен
  
  // Статус тикета (расширенный)
  status              String       @default("new") // new, open, in_progress, resolved, closed, pending
  
  // Приоритет чата
  priority            String       @default("normal") // low, normal, high, urgent
  
  // Теги/категории (JSON массив)
  tags                String?      // JSON массив строк, например: ["техподдержка", "продажи"]
  
  // Категория тикета
  category            String?      // Например: "техподдержка", "продажи", "возврат"
  
  // Описание/тема тикета
  subject             String?      // Краткое описание проблемы
  
  // Количество непрочитанных сообщений для оператора
  unreadCount         Int          @default(0)
  
  // Время первого ответа
  firstResponseAt     DateTime?    // Когда оператор впервые ответил
  
  // Время решения
  resolvedAt          DateTime?    // Когда тикет был решён
  
  // Время закрытия
  closedAt            DateTime?    // Когда тикет был закрыт
  
  // Причина закрытия
  closeReason         String?      // Например: "решено", "дубликат", "спам"
  
  // Оценка клиента (1-5)
  customerRating      Int?         // Рейтинг от клиента после закрытия
  
  // Заметки оператора (внутренние)
  internalNotes       String?      // Приватные заметки для операторов
  
  // Обновлено
  updatedAt           DateTime     @updatedAt

  clients             Client[]     @relation("ChatClients")
  organizationClients OrganizationClient[] @relation("ChatOrganizationClients")
  users               User[]       @relation("ChatUsers")
  messages            Message[]
  ticketHistory       TicketHistory[] // История изменений тикета

  @@unique([organizationId, ticketNumber]) // Уникальный номер тикета в рамках организации
  @@index([status]) // Индекс для быстрого поиска по статусу
  @@index([priority]) // Индекс для быстрого поиска по приоритету
  @@index([category]) // Индекс для быстрого поиска по категории
  @@index([channel]) // Индекс для поиска по каналу
  @@index([organizationId, receivingPhoneJid, remoteJid]) // Для WhatsApp
  @@index([organizationId, telegramBotId, telegramChatId]) // Для Telegram
}


model OrganizationPhone {
  id              Int            @id @default(autoincrement())
  organization    Organization   @relation(fields: [organizationId], references: [id])
  organizationId  Int
  phoneJid        String         @unique // например, 79001112233@s.whatsapp.net
  displayName     String?        // для подписи или отображения
  status          String         @default("pending") // pending, connected, logged_out, etc.
  lastConnectedAt DateTime?
  createdAt       DateTime       @default(now())
  qrCode          String? 
  updatedAt       DateTime       @updatedAt @default(now()) // <-- Добавлено @default(now())
                                                           // @updatedAt уже автоматически обновляет,
                                                           // но @default(now()) помогает при миграции для существующих строк.

  chats           Chat[] // Связь с моделью Chat
  messages        Message[] // Связь с моделью Message
}

// История изменений тикетов (аудит)
model TicketHistory {
  id              Int      @id @default(autoincrement())
  chat            Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId          Int
  
  // Кто внёс изменение
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId          Int?
  
  // Тип изменения
  changeType      String   // status_changed, assigned, priority_changed, tag_added, tag_removed, note_added, etc.
  
  // Старое значение
  oldValue        String?  // JSON или текст
  
  // Новое значение
  newValue        String?  // JSON или текст
  
  // Описание изменения
  description     String?  // Текстовое описание для пользователя
  
  // Когда произошло изменение
  createdAt       DateTime @default(now())

  @@index([chatId])
  @@index([changeType])
  @@index([createdAt])
}

// Telegram боты организации
model TelegramBot {
  id              Int      @id @default(autoincrement())
  organization    Organization @relation(fields: [organizationId], references: [id])
  organizationId  Int
  
  // Токен бота от BotFather
  botToken        String   @unique
  
  // Информация о боте
  botUsername     String?  // @bot_username
  botName         String?  // Имя бота
  botId           String?  // ID бота в Telegram
  
  // Статус бота
  status          String   @default("inactive") // inactive, active, error
  lastActiveAt    DateTime?
  
  // Настройки
  welcomeMessage  String?  // Приветственное сообщение
  autoReply       Boolean  @default(false) // Автоответы
  
  // Webhook URL (если используется)
  webhookUrl      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Связи
  chats           Chat[]
  messages        Message[]
  
  @@index([organizationId])
  @@index([status])
}

// Клиенты организации (компании и частные лица)
model OrganizationClient {
  id              Int      @id @default(autoincrement())
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId  Int
  
  // Тип клиента
  clientType      String   @default("individual") // individual (физ.лицо), company (юр.лицо)
  
  // Основная информация
  name            String   // ФИО для физ.лица или название компании
  email           String?
  phone           String?  // Основной телефон
  
  // Дополнительные контакты
  secondaryPhone  String?
  website         String?
  
  // Адрес
  address         String?
  city            String?
  country         String?
  postalCode      String?
  
  // Для юридических лиц
  companyName     String?  // Полное наименование компании
  taxId           String?  // ИНН/Tax ID
  registrationNumber String? // ОГРН/Registration number
  legalAddress    String?  // Юридический адрес
  
  // Контактное лицо (для компаний)
  contactPerson   String?  // Имя контактного лица
  contactPosition String?  // Должность
  contactPhone    String?  // Телефон контактного лица
  contactEmail    String?  // Email контактного лица
  
  // Статус клиента
  status          String   @default("active") // active, inactive, blocked, potential
  
  // Источник клиента
  source          String?  // website, referral, whatsapp, telegram, phone, email, etc.
  
  // Сегмент клиента
  segment         String?  // VIP, regular, wholesale, retail, etc.
  
  // Менеджер/ответственный
  assignedUserId  Int?
  assignedUser    User?    @relation("ClientManager", fields: [assignedUserId], references: [id], onDelete: SetNull)
  
  // Финансовая информация
  totalRevenue    Decimal? @db.Decimal(15, 2) // Общая выручка от клиента
  lastPurchaseDate DateTime? // Дата последней покупки
  purchaseCount   Int      @default(0) // Количество покупок
  averageCheck    Decimal? @db.Decimal(15, 2) // Средний чек
  
  // Скидка
  discount        Decimal? @db.Decimal(5, 2) // Персональная скидка в процентах
  
  // Дополнительные поля
  notes           String?  // Заметки о клиенте
  birthday        DateTime? // День рождения
  
  // Связь с мессенджерами
  whatsappJid     String?  // JID в WhatsApp
  telegramUserId  String?  // ID в Telegram
  
  // Маркетинговые разрешения
  emailSubscribed Boolean  @default(false) // Согласие на email-рассылку
  smsSubscribed   Boolean  @default(false) // Согласие на SMS-рассылку
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Связи
  chats           Chat[]   @relation("ChatOrganizationClients")
  tags            ClientTag[] @relation("ClientTags")
  
  // Индексы для оптимизации поиска
  @@index([organizationId])
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([segment])
  @@index([assignedUserId])
  @@index([clientType])
  @@index([whatsappJid])
  @@index([telegramUserId])
}

// Теги клиентов
model ClientTag {
  id              Int      @id @default(autoincrement())
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId  Int
  
  // Название тега
  name            String   // Например: "VIP", "Постоянный", "Проблемный"
  
  // Цвет для UI (hex)
  color           String?  @default("#3B82F6") // Например: "#FF5733"
  
  // Описание тега
  description     String?
  
  // Тип тега
  type            String   @default("custom") // custom, auto, system
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Связи
  clients         OrganizationClient[] @relation("ClientTags")
  
  @@unique([organizationId, name]) // Уникальное имя тега в рамках организации
  @@index([organizationId])
  @@index([type])
}

