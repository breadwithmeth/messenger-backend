# üé´ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—é—Ç —Ç–∏–∫–µ—Ç—ã

## –ü—Ä–æ–±–ª–µ–º–∞ ‚ùå

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏–ª–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞, —á–∞—Ç —Å–æ–∑–¥–∞–≤–∞–ª—Å—è, –Ω–æ –Ω–µ –ø–æ—è–≤–ª—è–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ —Ç–∏–∫–µ—Ç–æ–≤ (`GET /api/tickets`).

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞ –ø–æ–ª–µ `ticketNumber` –æ—Å—Ç–∞–≤–∞–ª–æ—Å—å `NULL`, –∞ API —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ —á–∞—Ç—ã —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º —Ç–∏–∫–µ—Ç–∞.

## –†–µ—à–µ–Ω–∏–µ ‚úÖ

### 1. –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Ç–∏–∫–µ—Ç–æ–≤

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞:

```typescript
// src/config/baileys.ts - —Ñ—É–Ω–∫—Ü–∏—è ensureChat()

const lastTicket = await prisma.chat.findFirst({
  where: { 
    organizationId,
    ticketNumber: { not: null }
  },
  orderBy: { ticketNumber: 'desc' },
});

const nextTicketNumber = (lastTicket?.ticketNumber || 0) + 1;

chat = await prisma.chat.create({
  data: {
    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è ...
    ticketNumber: nextTicketNumber,
    status: 'new',
    priority: 'medium',
  },
});
```

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —á–∞—Ç–æ–≤

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤ –≤—Å–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —á–∞—Ç–∞–º:

```bash
node scripts/migrate-ticket-numbers.js
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏:**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ 296 —á–∞—Ç–æ–≤
- ‚úÖ –ü—Ä–∏—Å–≤–æ–µ–Ω—ã –Ω–æ–º–µ—Ä–∞ –æ—Ç 1 –¥–æ 296
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å—Ç–∞—Ç—É—Å—ã –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã üß™

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```bash
GET /api/tickets
# –û—Ç–≤–µ—Ç: { tickets: [], pagination: { total: 0 } }
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```bash
GET /api/tickets
# –û—Ç–≤–µ—Ç: { tickets: [...296 —Ç–∏–∫–µ—Ç–æ–≤...], pagination: { total: 296 } }
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:

```bash
GET /api/tickets/stats
```

```json
{
  "total": 296,
  "byStatus": {
    "new": 295,
    "closed": 1
  },
  "byPriority": {
    "medium": 296
  }
}
```

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å üìù

### –§–∞–π–ª—ã:

1. **src/config/baileys.ts** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è `ticketNumber`
2. **scripts/migrate-ticket-numbers.js** - —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —á–∞—Ç–æ–≤
3. **MESSAGE_FLOW_DOCUMENTATION.md** - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
4. **TICKET_AUTO_NUMBER_IMPLEMENTATION.md** - –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ:

**–†–∞–Ω—å—à–µ:**
1. –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–∞—Ç
2. `ticketNumber = NULL`
3. –ß–∞—Ç –ù–ï –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ `/api/tickets` ‚ùå

**–°–µ–π—á–∞—Å:**
1. –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–∞—Ç
2. `ticketNumber` = –∞–≤—Ç–æ-–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç (297, 298, 299...)
3. `status = 'new'`, `priority = 'medium'`
4. –ß–∞—Ç –°–†–ê–ó–£ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ `/api/tickets` ‚úÖ

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç üîß

### –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:

```
WhatsApp ‚Üí Baileys ‚Üí messages.upsert event
                           ‚Üì
                      ensureChat()
                           ‚Üì
                   –ò—â–µ—Ç –º–∞–∫—Å. ticketNumber
                           ‚Üì
                   –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç + 1
                           ‚Üì
              –°–æ–∑–¥–∞–µ—Ç —á–∞—Ç —Å ticketNumber
                           ‚Üì
            status='new', priority='medium'
                           ‚Üì
              –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
                           ‚Üì
         –¢–∏–∫–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ GET /api/tickets
```

### –õ–æ–≥–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Ç–∏–∫–µ—Ç–∞:

```
‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —á–∞—Ç –¥–ª—è JID: 77079861373@s.whatsapp.net 
   (–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: 1, Phone ID: 4, ID —á–∞—Ç–∞: 297, –¢–∏–∫–µ—Ç #297)
üì¨ –£–≤–µ–ª–∏—á–µ–Ω —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è —á–∞—Ç–∞ 297
üíæ –°–æ–æ–±—â–µ–Ω–∏–µ (—Ç–∏–ø: text, ID: 5678) —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î
```

## –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ ‚öôÔ∏è

### –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–æ–º–µ—Ä–æ–≤

- –ù–æ–º–µ—Ä–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö **–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏**
- –†–∞–∑–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –º–æ–≥—É—Ç –∏–º–µ—Ç—å —Ç–∏–∫–µ—Ç—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏
- Constraint: `@@unique([organizationId, ticketNumber])`

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–æ–º–µ—Ä–æ–≤

- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è 1: —Ç–∏–∫–µ—Ç—ã 1, 2, 3, ..., 296, 297, 298...
- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è 2: —Ç–∏–∫–µ—Ç—ã 1, 2, 3, ... (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ 1)

### –°—Ç–∞—Ç—É—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

–í—Å–µ –Ω–æ–≤—ã–µ —Ç–∏–∫–µ—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"new"`:

```
new ‚Üí open ‚Üí in_progress ‚Üí resolved ‚Üí closed
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ üß™

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ç–∏–∫–µ—Ç—ã:

```bash
curl -s "http://localhost:4000/api/tickets?page=1&limit=10" \
  -H "Authorization: Bearer YOUR_TOKEN" | jq '.pagination.total'
# –û–∂–∏–¥–∞–µ—Ç—Å—è: 296
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:

```bash
curl -s "http://localhost:4000/api/tickets/stats" \
  -H "Authorization: Bearer YOUR_TOKEN" | jq
```

### 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ WhatsApp —Å –Ω–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `GET /api/tickets` - –Ω–æ–≤—ã–π —Ç–∏–∫–µ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è —Å –Ω–æ–º–µ—Ä–æ–º 297

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ üöÄ

- [ ] –ê–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º (round-robin)
- [ ] SLA –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (firstResponseAt, resolvedAt)
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Ç–∏–∫–µ—Ç–∞—Ö (WebSocket/SSE)
- [ ] –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∏–∫–µ—Ç–∞–º–∏
- [ ] –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–æ–≤ (–ø—Ä–µ—Ñ–∏–∫—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä "TKT-001")

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è üìö

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `TICKET_AUTO_NUMBER_IMPLEMENTATION.md`
- **–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–æ–±—â–µ–Ω–∏–π:** `MESSAGE_FLOW_DOCUMENTATION.md`
- **–¢–∏–∫–µ—Ç-—Å–∏—Å—Ç–µ–º–∞:** `TICKET_SYSTEM_DOCUMENTATION.md`
- **API –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:** `API_FRONTEND_GUIDE.md`

---

## –†–µ–∑—é–º–µ ‚ú®

‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞:** –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç —Ç–∏–∫–µ—Ç—ã  
‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞:** –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —á–∞—Ç—ã –∏–º–µ—é—Ç –Ω–æ–º–µ—Ä–∞ —Ç–∏–∫–µ—Ç–æ–≤  
‚úÖ **API —Ä–∞–±–æ—Ç–∞–µ—Ç:** `/api/tickets` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 296 —Ç–∏–∫–µ—Ç–æ–≤  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:** –ù–æ–º–µ—Ä–∞ –ø—Ä–∏—Å–≤–∞–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞  

**–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!** üéâ
